name: Fix Typing Imports

on:
  workflow_dispatch:

jobs:
  fix-imports:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Fix typing imports in all Python files
      run: |
        echo "ğŸ”§ ä¿®å¾©typingå°å…¥å•é¡Œ..."
        
        # ä¿®å¾© core/firebase_client.py
        if [ -f "scripts/core/firebase_client.py" ]; then
          echo "ä¿®å¾© core/firebase_client.py..."
          cat << 'EOF' > scripts/core/firebase_client.py
"""Firebaseå®¢æˆ¶ç«¯å°è£"""

import requests
import json
import os
from typing import Dict, Any, Optional

class FirebaseClient:
    """Firebaseæ“ä½œå®¢æˆ¶ç«¯"""
    
    def __init__(self, firebase_url: Optional[str] = None):
        self.firebase_url = firebase_url or os.getenv(
            'FIREBASE_URL', 
            'https://your-project-default-rtdb.asia-southeast1.firebasedatabase.app'
        )
    
    def save(self, path: str, data: Dict[str, Any]) -> bool:
        """ä¿å­˜è³‡æ–™åˆ°Firebase"""
        url = f"{self.firebase_url}/{path}.json"
        
        try:
            response = requests.put(url, json=data, timeout=10)
            return response.status_code == 200
        except Exception as e:
            print(f"âŒ Firebaseä¿å­˜å¤±æ•— {path}: {e}")
            return False
    
    def get(self, path: str) -> Optional[Dict[str, Any]]:
        """å¾Firebaseè®€å–è³‡æ–™"""
        url = f"{self.firebase_url}/{path}.json"
        
        try:
            response = requests.get(url, timeout=10)
            if response.status_code == 200:
                return response.json()
            return None
        except Exception as e:
            print(f"âŒ Firebaseè®€å–å¤±æ•— {path}: {e}")
            return None
    
    def update(self, path: str, data: Dict[str, Any]) -> bool:
        """æ›´æ–°Firebaseè³‡æ–™"""
        url = f"{self.firebase_url}/{path}.json"
        
        try:
            response = requests.patch(url, json=data, timeout=10)
            return response.status_code == 200
        except Exception as e:
            print(f"âŒ Firebaseæ›´æ–°å¤±æ•— {path}: {e}")
            return False
EOF
          echo "âœ… core/firebase_client.py ä¿®å¾©å®Œæˆ"
        fi
        
        # ä¿®å¾© generate_dashboard.py
        if [ -f "scripts/generate_dashboard.py" ]; then
          echo "ä¿®å¾© generate_dashboard.py..."
          sed -i '1i from typing import Dict, Any, List' scripts/generate_dashboard.py
          echo "âœ… generate_dashboard.py ä¿®å¾©å®Œæˆ"
        fi
        
        # ä¿®å¾© main_analyzer.py
        if [ -f "scripts/main_analyzer.py" ]; then
          echo "ä¿®å¾© main_analyzer.py..."
          sed -i '4i from typing import Dict, Any' scripts/main_analyzer.py
          echo "âœ… main_analyzer.py ä¿®å¾©å®Œæˆ"
        fi
        
        # æª¢æŸ¥ä¿®å¾©çµæœ
        echo ""
        echo "ğŸ” æª¢æŸ¥ä¿®å¾©çµæœ:"
        grep -n "from typing import" scripts/core/firebase_client.py || echo "âš ï¸ firebase_client.py æ²’æœ‰typingå°å…¥"
        grep -n "from typing import" scripts/generate_dashboard.py || echo "âš ï¸ generate_dashboard.py æ²’æœ‰typingå°å…¥"
        grep -n "from typing import" scripts/main_analyzer.py || echo "âš ï¸ main_analyzer.py æ²’æœ‰typingå°å…¥"
    
    - name: Test fixed imports
      run: |
        cd scripts
        echo "ğŸ§ª æ¸¬è©¦ä¿®å¾©å¾Œçš„å°å…¥..."
        
        cat << 'EOF' > test_fixed_imports.py
        import sys
        sys.path.append('.')
        
        print("æ¸¬è©¦ä¿®å¾©å¾Œçš„æ¨¡çµ„å°å…¥...")
        
        try:
            from core.firebase_client import FirebaseClient
            client = FirebaseClient()
            print("âœ… Firebaseå®¢æˆ¶ç«¯å°å…¥æˆåŠŸ")
        except Exception as e:
            print(f"âŒ Firebaseå®¢æˆ¶ç«¯å°å…¥å¤±æ•—: {e}")
            sys.exit(1)
        
        try:
            from generate_dashboard import ModularDashboard
            dashboard = ModularDashboard()
            print("âœ… å„€è¡¨æ¿æ¨¡çµ„å°å…¥æˆåŠŸ")
        except Exception as e:
            print(f"âŒ å„€è¡¨æ¿æ¨¡çµ„å°å…¥å¤±æ•—: {e}")
            sys.exit(1)
        
        try:
            import main_analyzer
            print("âœ… ä¸»åˆ†æå™¨å°å…¥æˆåŠŸ")
        except Exception as e:
            print(f"âŒ ä¸»åˆ†æå™¨å°å…¥å¤±æ•—: {e}")
            sys.exit(1)
        
        print("ğŸ‰ æ‰€æœ‰æ¨¡çµ„å°å…¥æ¸¬è©¦é€šé!")
        EOF
        
        python test_fixed_imports.py
    
    - name: Commit fixes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add scripts/
        git commit -m "ğŸ”§ Fix typing imports - Add missing Dict, Any, Optional imports

        - âœ… Fixed core/firebase_client.py
        - âœ… Fixed generate_dashboard.py  
        - âœ… Fixed main_analyzer.py
        - ğŸ¯ Resolved 'Dict' is not defined error" || echo "No changes to commit"
        
        git push
    
    - name: Success message
      run: |
        echo "ğŸ‰ typingå°å…¥å•é¡Œä¿®å¾©å®Œæˆ!"
        echo "ç¾åœ¨å¯ä»¥é‡æ–°åŸ·è¡ŒETFåˆ†ææ¸¬è©¦äº†"
