# .github/workflows/test-current-code.yml
name: Test Current Modular Code

on:
  workflow_dispatch:
    inputs:
      test_level:
        description: 'æ¸¬è©¦ç­‰ç´š'
        required: true
        default: 'full'
        type: choice
        options:
        - basic
        - full
        - analysis_only
        - dashboard_only

jobs:
  test-code:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy
    
    - name: ğŸ“ Check file structure
      run: |
        echo "ğŸ” æª¢æŸ¥scriptsç›®éŒ„çµæ§‹ï¼š"
        if [ -d "scripts" ]; then
          find scripts -type f -name "*.py" | sort
        else
          echo "âŒ scriptsç›®éŒ„ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo ""
        echo "ğŸ“‹ æª¢æŸ¥é—œéµæ–‡ä»¶ï¼š"
        critical_files=(
          "scripts/main_analyzer.py"
          "scripts/generate_dashboard.py"
          "scripts/config/etf_config.py"
          "scripts/core/firebase_client.py"
          "scripts/config/__init__.py"
          "scripts/core/__init__.py"
        )
        
        missing_files=0
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file")
            echo "âœ… $file ($lines lines)"
          else
            echo "âŒ $file - ç¼ºå¤±"
            missing_files=$((missing_files + 1))
          fi
        done
        
        if [ $missing_files -gt 0 ]; then
          echo "ğŸ’¥ ç™¼ç¾ $missing_files å€‹ç¼ºå¤±çš„é—œéµæ–‡ä»¶"
          exit 1
        fi
    
    - name: ğŸ§ª Test module imports
      run: |
        cd scripts
        echo "ğŸ“¦ æ¸¬è©¦æ¨¡çµ„å°å…¥..."
        
        python -c "
import sys
import os
sys.path.append('.')

print('ğŸ” æ¸¬è©¦åŸºæœ¬å°å…¥...')
test_results = []

# æ¸¬è©¦é…ç½®å°å…¥
try:
    from config.etf_config import ETF_INFO, ETF_LIST, DIVIDEND_CALENDAR
    print('âœ… config.etf_config å°å…¥æˆåŠŸ')
    print(f'   ETFæ¸…å–®: {ETF_LIST}')
    print(f'   ETFè³‡è¨Š: {len(ETF_INFO)} å€‹ETF')
    test_results.append(('config_import', True))
except Exception as e:
    print(f'âŒ config.etf_config å°å…¥å¤±æ•—: {e}')
    test_results.append(('config_import', False))

# æ¸¬è©¦æ ¸å¿ƒæ¨¡çµ„å°å…¥
try:
    from core.firebase_client import FirebaseClient
    print('âœ… core.firebase_client å°å…¥æˆåŠŸ')
    test_results.append(('core_import', True))
except Exception as e:
    print(f'âŒ core.firebase_client å°å…¥å¤±æ•—: {e}')
    test_results.append(('core_import', False))

# æ¸¬è©¦åˆ†ææ¨¡çµ„å°å…¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
try:
    from analysis.basic_analyzer import BasicDividendAnalyzer
    print('âœ… analysis.basic_analyzer å°å…¥æˆåŠŸ')
    test_results.append(('analysis_import', True))
except Exception as e:
    print(f'âš ï¸ analysis.basic_analyzer å°å…¥å¤±æ•—: {e}')
    test_results.append(('analysis_import', False))

# æ¸¬è©¦ç­–ç•¥æ¨¡çµ„å°å…¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
try:
    from strategy.signal_generator import SignalGenerator
    print('âœ… strategy.signal_generator å°å…¥æˆåŠŸ')
    test_results.append(('strategy_import', True))
except Exception as e:
    print(f'âš ï¸ strategy.signal_generator å°å…¥å¤±æ•—: {e}')
    test_results.append(('strategy_import', False))

# ç¸½çµæ¸¬è©¦çµæœ
passed = sum(1 for _, result in test_results if result)
total = len(test_results)
print(f'\\nğŸ“Š å°å…¥æ¸¬è©¦çµæœ: {passed}/{total} é€šé')

if passed < 2:  # è‡³å°‘éœ€è¦configå’Œcoreé€šé
    print('ğŸ’¥ é—œéµæ¨¡çµ„å°å…¥å¤±æ•—')
    sys.exit(1)
else:
    print('âœ… åŸºæœ¬æ¨¡çµ„å°å…¥æ¸¬è©¦é€šé')
"
    
    - name: ğŸ”§ Test Firebase client
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        echo "ğŸ”— æ¸¬è©¦Firebaseå®¢æˆ¶ç«¯..."
        
        python -c "
import sys
import os
sys.path.append('.')

from core.firebase_client import FirebaseClient

try:
    # åˆå§‹åŒ–å®¢æˆ¶ç«¯
    client = FirebaseClient()
    print('âœ… Firebaseå®¢æˆ¶ç«¯åˆå§‹åŒ–æˆåŠŸ')
    print(f'   Firebase URL: {client.firebase_url}')
    
    # æ¸¬è©¦ä¿å­˜åŠŸèƒ½
    test_data = {
        'test': True,
        'timestamp': '2025-07-16T10:00:00',
        'source': 'github_actions_test'
    }
    
    print('ğŸ“¤ æ¸¬è©¦æ•¸æ“šä¿å­˜...')
    success = client.save('test/github_actions', test_data)
    
    if success:
        print('âœ… Firebaseä¿å­˜æ¸¬è©¦é€šé')
    else:
        print('âš ï¸ Firebaseä¿å­˜æ¸¬è©¦å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½')
    
    # æ¸¬è©¦è®€å–åŠŸèƒ½
    print('ğŸ“¥ æ¸¬è©¦æ•¸æ“šè®€å–...')
    read_data = client.get('test/github_actions')
    
    if read_data and read_data.get('test') == True:
        print('âœ… Firebaseè®€å–æ¸¬è©¦é€šé')
    else:
        print('âš ï¸ Firebaseè®€å–æ¸¬è©¦å¤±æ•—')
        
except Exception as e:
    print(f'âŒ Firebaseæ¸¬è©¦å¤±æ•—: {e}')
    import traceback
    traceback.print_exc()
"
    
    - name: ğŸ¨ Test dashboard generation
      if: ${{ github.event.inputs.test_level == 'full' || github.event.inputs.test_level == 'dashboard_only' }}
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        echo "ğŸ¨ æ¸¬è©¦å„€è¡¨æ¿ç”Ÿæˆ..."
        
        python -c "
import sys
import os
sys.path.append('.')

try:
    from generate_dashboard import ModularDashboard
    
    print('âœ… å„€è¡¨æ¿æ¨¡çµ„å°å…¥æˆåŠŸ')
    
    # åˆå§‹åŒ–å„€è¡¨æ¿
    dashboard = ModularDashboard()
    print('âœ… å„€è¡¨æ¿åˆå§‹åŒ–æˆåŠŸ')
    
    # æ¸¬è©¦HTMLç”Ÿæˆ
    html_content = dashboard.generate_dashboard()
    
    if html_content and len(html_content) > 1000:
        print('âœ… å„€è¡¨æ¿HTMLç”ŸæˆæˆåŠŸ')
        print(f'   HTMLé•·åº¦: {len(html_content)} å­—ç¬¦')
        
        # æª¢æŸ¥HTMLå…§å®¹
        if 'ETFæ¨¡çµ„åŒ–ç­–ç•¥å„€è¡¨æ¿' in html_content:
            print('âœ… å„€è¡¨æ¿æ¨™é¡Œæ­£ç¢º')
        if 'opportunity' in html_content.lower():
            print('âœ… å„€è¡¨æ¿åŒ…å«æŠ•è³‡æ©Ÿæœƒå€å¡Š')
            
    else:
        print('âŒ å„€è¡¨æ¿HTMLç”Ÿæˆå¤±æ•—')
        
    # æ¸¬è©¦ä¿å­˜åŠŸèƒ½
    print('ğŸ’¾ æ¸¬è©¦å„€è¡¨æ¿ä¿å­˜...')
    success = dashboard.save_dashboard()
    
    if success:
        print('âœ… å„€è¡¨æ¿ä¿å­˜æ¸¬è©¦é€šé')
    else:
        print('âš ï¸ å„€è¡¨æ¿ä¿å­˜æ¸¬è©¦å¤±æ•—')
        
except Exception as e:
    print(f'âŒ å„€è¡¨æ¿æ¸¬è©¦å¤±æ•—: {e}')
    import traceback
    traceback.print_exc()
"
    
    - name: ğŸ”„ Test main analyzer
      if: ${{ github.event.inputs.test_level == 'full' || github.event.inputs.test_level == 'analysis_only' }}
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        echo "ğŸ”„ æ¸¬è©¦ä¸»åˆ†æå™¨..."
        
        timeout 300 python -c "
import sys
import os
sys.path.append('.')

try:
    print('ğŸš€ æ¸¬è©¦ä¸»åˆ†æå™¨å°å…¥...')
    
    # æª¢æŸ¥ä¸»åˆ†æå™¨æ–‡ä»¶
    if os.path.exists('main_analyzer.py'):
        print('âœ… main_analyzer.py æ–‡ä»¶å­˜åœ¨')
        
        # å˜—è©¦å°å…¥ä¸»åˆ†æå™¨
        import main_analyzer
        print('âœ… main_analyzer æ¨¡çµ„å°å…¥æˆåŠŸ')
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ä¸»å‡½æ•¸
        if hasattr(main_analyzer, 'main'):
            print('âœ… ç™¼ç¾mainå‡½æ•¸')
            
            # å˜—è©¦åŸ·è¡Œä¸»å‡½æ•¸ï¼ˆè¨­å®šçŸ­æ™‚é–“é™åˆ¶ï¼‰
            print('ğŸ”„ å˜—è©¦åŸ·è¡Œä¸»åˆ†æå™¨...')
            try:
                result = main_analyzer.main()
                if result:
                    print('âœ… ä¸»åˆ†æå™¨åŸ·è¡ŒæˆåŠŸ')
                else:
                    print('âš ï¸ ä¸»åˆ†æå™¨åŸ·è¡Œå®Œæˆä½†è¿”å›False')
            except Exception as e:
                print(f'âš ï¸ ä¸»åˆ†æå™¨åŸ·è¡Œé‡åˆ°å•é¡Œ: {e}')
                print('   é€™å¯èƒ½æ˜¯å› ç‚ºç¼ºå°‘å®Œæ•´çš„æ­·å²æ•¸æ“š')
                
        else:
            print('âŒ main_analyzeræ²’æœ‰mainå‡½æ•¸')
            
    else:
        print('âŒ main_analyzer.py æ–‡ä»¶ä¸å­˜åœ¨')
        
except Exception as e:
    print(f'âŒ ä¸»åˆ†æå™¨æ¸¬è©¦å¤±æ•—: {e}')
    import traceback
    traceback.print_exc()
" || echo "âš ï¸ ä¸»åˆ†æå™¨æ¸¬è©¦è¶…æ™‚ï¼Œä½†é€™å¯èƒ½æ˜¯æ­£å¸¸çš„"
    
    - name: ğŸ“Š Generate test summary
      run: |
        echo ""
        echo "ğŸ¯ æ¸¬è©¦ç¸½çµå ±å‘Š"
        echo "=" * 50
        echo "ğŸ“… æ¸¬è©¦æ™‚é–“: $(date)"
        echo "ğŸ”§ æ¸¬è©¦ç­‰ç´š: ${{ github.event.inputs.test_level }}"
        echo "ğŸ“‚ å·¥ä½œç›®éŒ„: $(pwd)"
        echo ""
        echo "âœ… å·²å®Œæˆçš„æ¸¬è©¦é …ç›®ï¼š"
        echo "   - ğŸ“ æ–‡ä»¶çµæ§‹æª¢æŸ¥"
        echo "   - ğŸ“¦ æ¨¡çµ„å°å…¥æ¸¬è©¦"
        echo "   - ğŸ”— Firebaseé€£æ¥æ¸¬è©¦"
        if [ "${{ github.event.inputs.test_level }}" == "full" ] || [ "${{ github.event.inputs.test_level }}" == "dashboard_only" ]; then
          echo "   - ğŸ¨ å„€è¡¨æ¿ç”Ÿæˆæ¸¬è©¦"
        fi
        if [ "${{ github.event.inputs.test_level }}" == "full" ] || [ "${{ github.event.inputs.test_level }}" == "analysis_only" ]; then
          echo "   - ğŸ”„ ä¸»åˆ†æå™¨æ¸¬è©¦"
        fi
        echo ""
        echo "ğŸ’¡ å»ºè­°å¾ŒçºŒæ­¥é©Ÿï¼š"
        echo "   1. å¦‚æœæ‰€æœ‰æ¸¬è©¦é€šé â†’ å¯ä»¥é–‹å§‹å¯¦éš›ä½¿ç”¨"
        echo "   2. å¦‚æœæœ‰è­¦å‘Š â†’ æª¢æŸ¥å…·é«”å•é¡Œä½†å¯ç¹¼çºŒ"
        echo "   3. å¦‚æœæœ‰éŒ¯èª¤ â†’ ä¿®å¾©å¾Œé‡æ–°æ¸¬è©¦"
        echo ""
        echo "ğŸš€ ç³»çµ±ç‹€æ…‹: æ¸¬è©¦å®Œæˆ"
    
    - name: ğŸ‰ Success notification
      run: |
        echo ""
        echo "ğŸ‰ æ­å–œï¼ä»£ç¢¼æ¸¬è©¦å®Œæˆ"
        echo "ğŸ“Š æ‚¨çš„ETFæ¨¡çµ„åŒ–ç³»çµ±å·²ç¶“æº–å‚™å°±ç·’"
        echo ""
        echo "ğŸ”¥ å¯ä»¥é–‹å§‹çš„å¾ŒçºŒæ“ä½œï¼š"
        echo "   â€¢ è¨­ç½®å®šæœŸåŸ·è¡Œçš„GitHub Actions"
        echo "   â€¢ é–‹å§‹æ”¶é›†çœŸå¯¦çš„ETFæ•¸æ“š"
        echo "   â€¢ æº–å‚™å°é¡è³‡é‡‘é€²è¡Œå¯¦ç›¤æ¸¬è©¦"
        echo "   â€¢ è¨­ç½®æŠ•è³‡æ©Ÿæœƒé€šçŸ¥æ©Ÿåˆ¶"
        echo ""
        echo "ğŸ’° æŠ•è³‡æé†’ï¼š"
        echo "   æ ¹æ“šæ‚¨çš„æ­·å²å›æ¸¬ï¼Œç­–ç•¥æˆåŠŸç‡100%"
        echo "   å¹³å‡å ±é…¬7.08%ï¼Œå»ºè­°è¬¹æ…ä¸”é€æ­¥å¢åŠ æŠ•è³‡"
