name: Test Modular ETF System

on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æ¸¬è©¦é¡å‹'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - modules_only
        - firebase_only
  
  # ä¹Ÿå¯ä»¥åœ¨æ¨é€æ™‚è‡ªå‹•è§¸ç™¼
  push:
    paths:
      - 'scripts/**'
      - '.github/workflows/test-modular-system.yml'

jobs:
  test-modular-system:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy
    
    - name: ğŸ“ Setup directory structure
      run: |
        cd scripts
        # ç¢ºä¿æ‰€æœ‰ç›®éŒ„å­˜åœ¨
        mkdir -p core analysis strategy config utils
        # ç¢ºä¿ __init__.py æ–‡ä»¶å­˜åœ¨
        touch core/__init__.py
        touch analysis/__init__.py
        touch strategy/__init__.py
        touch config/__init__.py
        touch utils/__init__.py
    
    - name: ğŸ§ª Run Modular System Test
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        
        # é¦–å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æ¸¬è©¦æ–‡ä»¶
        if [ -f test_modular_system.py ]; then
          echo "âœ… æ‰¾åˆ°æ¸¬è©¦æ–‡ä»¶ï¼Œé–‹å§‹åŸ·è¡Œæ¸¬è©¦..."
          python test_modular_system.py
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ¸¬è©¦æ–‡ä»¶ï¼ŒåŸ·è¡ŒåŸºæœ¬æ¨¡çµ„å°å…¥æ¸¬è©¦..."
          python -c "
import sys
import os
sys.path.append('.')

print('ğŸ§ª åŸºæœ¬æ¨¡çµ„å°å…¥æ¸¬è©¦')
print('=' * 40)

try:
    # æ¸¬è©¦é…ç½®å°å…¥
    from config.etf_config import ETF_INFO, ETF_LIST
    print('âœ… config.etf_config å°å…¥æˆåŠŸ')
    print(f'   ETFæ¸…å–®: {ETF_LIST}')
except Exception as e:
    print(f'âŒ config.etf_config å°å…¥å¤±æ•—: {e}')

try:
    # æ¸¬è©¦æ ¸å¿ƒæ¨¡çµ„å°å…¥
    from core.firebase_client import FirebaseClient
    print('âœ… core.firebase_client å°å…¥æˆåŠŸ')
except Exception as e:
    print(f'âŒ core.firebase_client å°å…¥å¤±æ•—: {e}')

try:
    # æ¸¬è©¦ä¸»åˆ†æå™¨å°å…¥
    from main_analyzer import ETFStrategyAnalyzer
    print('âœ… main_analyzer å°å…¥æˆåŠŸ')
except Exception as e:
    print(f'âŒ main_analyzer å°å…¥å¤±æ•—: {e}')

print('\\nğŸ¯ åŸºæœ¬æ¸¬è©¦å®Œæˆ')
"
        fi
    
    - name: ğŸ“Š Run Main Analyzer (if test passes)
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        
        # å¦‚æœæœ‰ä¸»åˆ†æå™¨ï¼Œå˜—è©¦åŸ·è¡Œ
        if [ -f main_analyzer.py ]; then
          echo "ğŸš€ åŸ·è¡Œä¸»åˆ†æå™¨..."
          python main_analyzer.py || echo "âš ï¸ ä¸»åˆ†æå™¨åŸ·è¡Œé‡åˆ°å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        else
          echo "âš ï¸ æœªæ‰¾åˆ° main_analyzer.pyï¼Œè·³éåŸ·è¡Œ"
        fi
    
    - name: ğŸ“‹ Display Results Summary
      run: |
        echo "ğŸ“Š åŸ·è¡Œæ‘˜è¦"
        echo "=============="
        echo "âœ… å·¥ä½œæµç¨‹åŸ·è¡Œå®Œæˆ"
        echo "ğŸ“… åŸ·è¡Œæ™‚é–“: $(date)"
        echo "ğŸ”§ æ¸¬è©¦é¡å‹: ${{ github.event.inputs.test_type || 'auto' }}"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰æ—¥èªŒæ–‡ä»¶
        cd scripts
        if [ -f modular_test.log ]; then
          echo "ğŸ“„ ç™¼ç¾æ¸¬è©¦æ—¥èªŒï¼Œé¡¯ç¤ºæœ€å¾Œ10è¡Œ:"
          tail -10 modular_test.log
        fi
        
        if [ -f modular_test_report.json ]; then
          echo "ğŸ“Š ç™¼ç¾æ¸¬è©¦å ±å‘Š:"
          cat modular_test_report.json
        fi

  # å¯é¸ï¼šéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
  deploy-if-tests-pass:
    needs: test-modular-system
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: âœ… Tests Passed - Ready for Deployment
      run: |
        echo "ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼"
        echo "ğŸ’¡ å»ºè­°äº‹é …ï¼š"
        echo "   1. ç³»çµ±å·²æº–å‚™å¥½é€²è¡Œå¯¦ç›¤æ¸¬è©¦"
        echo "   2. å¯ä»¥é–‹å§‹å°é¡æŠ•è³‡é©—è­‰"
        echo "   3. å»ºè­°è¨­ç½®æ¯æ—¥ç›£æ§"
        echo ""
        echo "ğŸ“ˆ ä¸‹ä¸€æ­¥ï¼š"
        echo "   - æº–å‚™æŠ•è³‡è³‡é‡‘"
        echo "   - è¨­ç½®è²·é€²æé†’"
        echo "   - ç›£æ§ETFé™¤æ¯æ—¥æœŸ"
