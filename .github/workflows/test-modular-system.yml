# .github/workflows/test-modular-system.yml
name: Test Modular ETF System

on:
  workflow_dispatch:
  push:
    paths:
      - 'scripts/**'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests pandas numpy
    
    - name: Create test structure
      run: |
        cd scripts
        mkdir -p core analysis strategy config
        touch core/__init__.py analysis/__init__.py strategy/__init__.py config/__init__.py
    
    - name: Create basic test script
      run: |
        cd scripts
        cat > basic_test.py << 'EOF'
import sys
import os

print("ðŸ§ª åŸºæœ¬æ¨¡çµ„æ¸¬è©¦é–‹å§‹")
print("=" * 40)

# æ¸¬è©¦è·¯å¾‘
sys.path.append('.')
print(f"Pythonè·¯å¾‘: {sys.path[-1]}")

# æ¸¬è©¦æ–‡ä»¶å­˜åœ¨
files_to_check = [
    'config/etf_config.py',
    'core/firebase_client.py', 
    'main_analyzer.py'
]

for file_path in files_to_check:
    if os.path.exists(file_path):
        print(f"âœ… æ‰¾åˆ°æ–‡ä»¶: {file_path}")
    else:
        print(f"âŒ ç¼ºå°‘æ–‡ä»¶: {file_path}")

# æ¸¬è©¦å°Žå…¥
test_passed = 0
test_total = 0

try:
    test_total += 1
    from config.etf_config import ETF_INFO
    print("âœ… config.etf_config å°Žå…¥æˆåŠŸ")
    test_passed += 1
except Exception as e:
    print(f"âŒ config.etf_config å°Žå…¥å¤±æ•—: {e}")

try:
    test_total += 1
    from core.firebase_client import FirebaseClient
    print("âœ… core.firebase_client å°Žå…¥æˆåŠŸ")
    test_passed += 1
except Exception as e:
    print(f"âŒ core.firebase_client å°Žå…¥å¤±æ•—: {e}")

print(f"\nðŸ“Š æ¸¬è©¦çµæžœ: {test_passed}/{test_total} é€šéŽ")
print(f"ðŸ“ˆ æˆåŠŸçŽ‡: {test_passed/test_total*100:.1f}%")

if test_passed == test_total:
    print("ðŸŽ‰ æ‰€æœ‰åŸºæœ¬æ¸¬è©¦é€šéŽï¼")
    exit(0)
else:
    print("âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—")
    exit(1)
EOF
    
    - name: Run basic test
      run: |
        cd scripts
        python basic_test.py
    
    - name: Run main analyzer (if exists)
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        if [ -f main_analyzer.py ]; then
          echo "ðŸš€ åŸ·è¡Œä¸»åˆ†æžå™¨..."
          timeout 300 python main_analyzer.py || echo "âš ï¸ ä¸»åˆ†æžå™¨åŸ·è¡Œè¶…æ™‚æˆ–é‡åˆ°å•é¡Œ"
        else
          echo "âš ï¸ main_analyzer.py ä¸å­˜åœ¨"
        fi
    
    - name: Summary
      run: |
        echo "ðŸ“Š æ¸¬è©¦å®Œæˆ"
        echo "æ™‚é–“: $(date)"
        echo "âœ… åŸºæœ¬æ¨¡çµ„æ¸¬è©¦å·²åŸ·è¡Œ"
