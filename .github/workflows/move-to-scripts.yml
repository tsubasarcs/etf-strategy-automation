# .github/workflows/move-to-scripts.yml
name: Move Files to Scripts Directory

on: workflow_dispatch

jobs:
  move-files:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ” æª¢æŸ¥ç•¶å‰æ–‡ä»¶ä½ç½®
      run: |
        echo "ğŸ“‚ ç•¶å‰ä¸»ç›®éŒ„ä¸‹çš„Pythonæ–‡ä»¶ï¼š"
        find . -maxdepth 1 -name "*.py" | grep -v __pycache__
        
        echo ""
        echo "ğŸ“ ç•¶å‰ç›®éŒ„çµæ§‹ï¼š"
        find . -maxdepth 2 -type d | grep -E "(config|core|analysis|strategy)" || echo "æ²’æœ‰æ‰¾åˆ°æ¨¡çµ„ç›®éŒ„"
    
    - name: ğŸ—ï¸ å‰µå»ºscriptsç›®éŒ„çµæ§‹
      run: |
        mkdir -p scripts
        mkdir -p scripts/{config,core,analysis,strategy,utils}
    
    - name: ğŸ“¦ ç§»å‹•Pythonæ–‡ä»¶åˆ°scriptsç›®éŒ„
      run: |
        # ç§»å‹•ä¸»ç›®éŒ„ä¸‹çš„Pythonæ–‡ä»¶
        for file in *.py; do
          if [ -f "$file" ]; then
            echo "ğŸ“¦ ç§»å‹• $file -> scripts/$file"
            mv "$file" scripts/
          fi
        done
        
        # ç§»å‹•æ¨¡çµ„ç›®éŒ„
        for dir in config core analysis strategy utils; do
          if [ -d "$dir" ]; then
            echo "ğŸ“ ç§»å‹•ç›®éŒ„ $dir -> scripts/$dir"
            cp -r "$dir"/* scripts/"$dir"/ 2>/dev/null || echo "ç›®éŒ„ $dir æ˜¯ç©ºçš„æˆ–ä¸å­˜åœ¨"
            rm -rf "$dir"
          fi
        done
        
        # ç¢ºä¿__init__.pyæ–‡ä»¶å­˜åœ¨
        for dir in config core analysis strategy utils; do
          if [ ! -f "scripts/$dir/__init__.py" ]; then
            touch "scripts/$dir/__init__.py"
            echo "âœ… å‰µå»º scripts/$dir/__init__.py"
          fi
        done
    
    - name: ğŸ”§ ä¿®å¾©å°å…¥è·¯å¾‘å•é¡Œ
      run: |
        cd scripts
        
        # æª¢æŸ¥ä¸¦ä¿®å¾©main_analyzer.pyä¸­çš„è·¯å¾‘å•é¡Œ
        if [ -f main_analyzer.py ]; then
          echo "ğŸ”§ ä¿®å¾©main_analyzer.pyçš„å°å…¥è·¯å¾‘..."
          
          # å‰µå»ºä¿®å¾©ç‰ˆæœ¬
          cat > main_analyzer_fixed.py << 'EOF'
"""ETFç­–ç•¥ä¸»åˆ†æç¨‹å¼ - è·¯å¾‘ä¿®å¾©ç‰ˆ"""

import sys
import os
from datetime import datetime, date
from typing import Dict, Any

# æ·»åŠ ç•¶å‰ç›®éŒ„åˆ°Pythonè·¯å¾‘
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

def main():
    """ä¸»å‡½æ•¸"""
    print("ğŸš€ ETFç­–ç•¥åˆ†æç³»çµ±å•Ÿå‹• (scriptsç›®éŒ„ç‰ˆ)")
    print("=" * 50)
    
    try:
        # æ¸¬è©¦æ¨¡çµ„å°å…¥
        print("ğŸ“¦ æ¸¬è©¦æ¨¡çµ„å°å…¥...")
        
        from config.etf_config import ETF_INFO, ETF_LIST, DIVIDEND_CALENDAR
        print(f"âœ… é…ç½®è¼‰å…¥æˆåŠŸï¼ŒETFæ¸…å–®: {ETF_LIST}")
        
        from core.firebase_client import FirebaseClient
        print("âœ… Firebaseå®¢æˆ¶ç«¯è¼‰å…¥æˆåŠŸ")
        
        # åˆå§‹åŒ–Firebaseå®¢æˆ¶ç«¯
        firebase_client = FirebaseClient()
        
        # æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
        test_data = {
            'test': True,
            'timestamp': datetime.now().isoformat(),
            'message': 'ETFç³»çµ±è·¯å¾‘ä¿®å¾©æ¸¬è©¦'
        }
        
        print("ğŸ”— æ¸¬è©¦Firebaseé€£æ¥...")
        success = firebase_client.save('test/path_fix', test_data)
        if success:
            print("âœ… Firebaseé€£æ¥æ­£å¸¸")
        else:
            print("âš ï¸ Firebaseé€£æ¥å¤±æ•—ï¼Œä½†ç³»çµ±å¯ä»¥ç¹¼çºŒé‹è¡Œ")
        
        # æ¸¬è©¦åˆ†ææ¨¡çµ„
        if os.path.exists('analysis/basic_analyzer.py'):
            from analysis.basic_analyzer import BasicDividendAnalyzer
            analyzer = BasicDividendAnalyzer()
            opportunities = analyzer.find_dividend_opportunities()
            print(f"âœ… åˆ†ææ¨¡çµ„è¼‰å…¥æˆåŠŸï¼Œæ‰¾åˆ° {len(opportunities)} å€‹æ©Ÿæœƒ")
        else:
            print("âš ï¸ åˆ†ææ¨¡çµ„æ–‡ä»¶ä¸å­˜åœ¨")
        
        print(f"\nğŸ‰ è·¯å¾‘ä¿®å¾©å®Œæˆï¼ç³»çµ±é‹è¡Œæ­£å¸¸")
        print(f"ğŸ“ ç•¶å‰å·¥ä½œç›®éŒ„: {os.getcwd()}")
        print(f"ğŸ“‚ Pythonè·¯å¾‘: {sys.path[-1]}")
        
        return True
        
    except Exception as e:
        print(f"âŒ åŸ·è¡Œå¤±æ•—: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    main()
EOF
          
          # æ›¿æ›åŸæ–‡ä»¶
          mv main_analyzer_fixed.py main_analyzer.py
          echo "âœ… main_analyzer.py è·¯å¾‘å·²ä¿®å¾©"
        fi
    
    - name: ğŸ“Š é©—è­‰ç§»å‹•çµæœ
      run: |
        echo "ğŸ¯ ç§»å‹•å¾Œçš„æ–‡ä»¶çµæ§‹ï¼š"
        find scripts -type f -name "*.py" | sort
        
        echo ""
        echo "ğŸ“ æª¢æŸ¥é—œéµæ–‡ä»¶ï¼š"
        key_files=(
          "scripts/main_analyzer.py"
          "scripts/config/etf_config.py"
          "scripts/core/firebase_client.py"
        )
        
        for file in "${key_files[@]}"; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file")
            echo "âœ… $file ($lines lines)"
          else
            echo "âŒ $file - ç¼ºå¤±"
          fi
        done
    
    - name: ğŸ§¹ æ¸…ç†ä¸»ç›®éŒ„
      run: |
        # æ¸…ç†ä¸»ç›®éŒ„ä¸‹å¯èƒ½æ®˜ç•™çš„ç©ºç›®éŒ„å’Œæ–‡ä»¶
        echo "ğŸ§¹ æ¸…ç†ä¸»ç›®éŒ„..."
        
        # åˆªé™¤ç©ºçš„æ¨¡çµ„ç›®éŒ„
        for dir in config core analysis strategy utils; do
          if [ -d "$dir" ] && [ -z "$(ls -A $dir)" ]; then
            rmdir "$dir"
            echo "ğŸ—‘ï¸ åˆªé™¤ç©ºç›®éŒ„: $dir"
          fi
        done
        
        # æª¢æŸ¥æ˜¯å¦é‚„æœ‰Pythonæ–‡ä»¶åœ¨ä¸»ç›®éŒ„
        remaining_py=$(find . -maxdepth 1 -name "*.py" | grep -v __pycache__ || true)
        if [ -n "$remaining_py" ]; then
          echo "âš ï¸ ä¸»ç›®éŒ„é‚„æœ‰é€™äº›Pythonæ–‡ä»¶ï¼š"
          echo "$remaining_py"
        else
          echo "âœ… ä¸»ç›®éŒ„å·²æ¸…ç†ä¹¾æ·¨"
        fi
    
    - name: ğŸ’¾ æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ–°æ–‡ä»¶
        git add scripts/
        
        # åˆªé™¤èˆŠæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        for file in main_analyzer.py config core analysis strategy utils; do
          if git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
            git rm -r "$file" 2>/dev/null || true
          fi
        done
        
        git commit -m "ğŸ“¦ Move all files to scripts/ directory and fix import paths" || echo "No changes to commit"
        git push
    
    - name: ğŸ‰ å®Œæˆå ±å‘Š
      run: |
        echo ""
        echo "ğŸ‰ æ–‡ä»¶ç§»å‹•å®Œæˆï¼"
        echo "=" * 40
        echo "âœ… æ‰€æœ‰Pythonæ–‡ä»¶å·²ç§»å‹•åˆ°scripts/ç›®éŒ„"
        echo "âœ… ç›®éŒ„çµæ§‹å·²æ¨™æº–åŒ–"
        echo "âœ… å°å…¥è·¯å¾‘å·²ä¿®å¾©"
        echo "âœ… __init__.pyæ–‡ä»¶å·²ç¢ºä¿å­˜åœ¨"
        echo ""
        echo "ğŸš€ ç¾åœ¨å¯ä»¥åŸ·è¡Œæ¸¬è©¦å·¥ä½œæµç¨‹äº†ï¼"
