name: ETF Strategy Analysis - Production v2.0

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ 15:30 åŸ·è¡Œ (UTC+8 = UTC 07:30)
    - cron: '30 7 * * 1-5'
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'åˆ†ææ¨¡å¼'
        required: false
        default: 'standard'
        type: choice
        options:
        - standard
        - test_only
        - ssl_debug

env:
  FIREBASE_URL: ${{ secrets.FIREBASE_URL }}

jobs:
  etf-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy lxml beautifulsoup4 urllib3 certifi
        
        # å˜—è©¦è§£æ±ºSSLå•é¡Œ
        pip install --upgrade requests[security] pyOpenSSL certifi
    
    - name: ğŸ”§ Setup SSL handling
      run: |
        echo "ğŸ”§ é…ç½®SSLè™•ç†..."
        python -c "
        import ssl
        import certifi
        import requests
        print('SSL Context:', ssl.create_default_context())
        print('Certifi path:', certifi.where())
        print('Requests version:', requests.__version__)
        "
    
    - name: ğŸ§ª Test configuration system
      run: |
        cd scripts
        echo "ğŸ§ª æ¸¬è©¦é…ç½®ç³»çµ±..."
        python -c "
        import sys, os
        sys.path.append('config')
        sys.path.append('core')
        
        try:
            # æ¸¬è©¦é…ç½®ç³»çµ±
            from config_manager import get_dividend_schedule
            schedule = get_dividend_schedule()
            print(f'âœ… é…ç½®ç³»çµ±æ­£å¸¸: {len(schedule)} å€‹ETF')
            
            # é¡¯ç¤ºé™¤æ¯æ—¥ç¨‹
            from datetime import datetime, date
            today = date.today()
            print(f'ğŸ“… é™¤æ¯æ—¥ç¨‹ (ç›¸å°ä»Šæ—¥):')
            for etf, dates in schedule.items():
                if dates:
                    next_date = dates[0]
                    try:
                        next_date_obj = datetime.strptime(next_date, '%Y-%m-%d').date()
                        days_diff = (next_date_obj - today).days
                        print(f'   {etf}: {next_date} ({days_diff}å¤©å¾Œ)')
                    except:
                        print(f'   {etf}: {next_date}')
            
            # æ¸¬è©¦ETFåŸºæœ¬é…ç½®
            from config.etf_config import ETF_LIST, ETF_INFO
            print(f'âœ… ETFåŸºæœ¬é…ç½®: {len(ETF_LIST)} å€‹ETF')
            
            # æ¸¬è©¦Firebaseå®¢æˆ¶ç«¯
            from core.firebase_client import FirebaseClient
            client = FirebaseClient()
            print('âœ… Firebaseå®¢æˆ¶ç«¯åˆå§‹åŒ–æˆåŠŸ')
            
        except Exception as e:
            print(f'âŒ é…ç½®ç³»çµ±éŒ¯èª¤: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
    
    - name: ğŸŒ Test API connectivity
      if: ${{ github.event.inputs.analysis_mode == 'ssl_debug' }}
      run: |
        cd scripts
        echo "ğŸŒ æ¸¬è©¦APIé€£æ¥..."
        python -c "
        import requests
        import ssl
        import urllib3
        
        # ç¦ç”¨SSLè­¦å‘Šé€²è¡Œæ¸¬è©¦
        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
        
        test_urls = [
            'https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=20250701&stockNo=0050',
            'https://httpbin.org/get'  # å‚™ç”¨æ¸¬è©¦URL
        ]
        
        for i, url in enumerate(test_urls):
            try:
                print(f'æ¸¬è©¦ URL {i+1}: {url}')
                
                # æ¸¬è©¦æ­£å¸¸é€£æ¥
                response = requests.get(url, timeout=10, verify=True)
                print(f'âœ… æ­£å¸¸é€£æ¥æˆåŠŸ: {response.status_code}')
                break
                
            except requests.exceptions.SSLError:
                print(f'âš ï¸ SSLéŒ¯èª¤ï¼Œå˜—è©¦è·³éSSLé©—è­‰...')
                try:
                    response = requests.get(url, timeout=10, verify=False)
                    print(f'âœ… è·³éSSLé©—è­‰æˆåŠŸ: {response.status_code}')
                    break
                except Exception as e2:
                    print(f'âŒ è·³éSSLä¹Ÿå¤±æ•—: {e2}')
                    
            except Exception as e:
                print(f'âŒ é€£æ¥å¤±æ•—: {e}')
        "
    
    - name: ğŸ”„ Run main analysis
      if: ${{ github.event.inputs.analysis_mode != 'test_only' }}
      timeout-minutes: 10
      run: |
        cd scripts
        echo "ğŸ”„ é–‹å§‹åŸ·è¡Œä¸»åˆ†æç¨‹å¼..."
        
        # è¨­å®šç’°å¢ƒè®Šæ•¸ä»¥è™•ç†SSLå•é¡Œ
        export PYTHONHTTPSVERIFY=0
        export REQUESTS_CA_BUNDLE=""
        export CURL_CA_BUNDLE=""
        
        python main_analyzer.py || {
          echo "âš ï¸ ä¸»åˆ†æå™¨åŸ·è¡Œé‡åˆ°å•é¡Œï¼Œæª¢æŸ¥è©³ç´°æ—¥èªŒ..."
          echo "é€™å¯èƒ½æ˜¯SSLæˆ–ç¶²è·¯é€£æ¥å•é¡Œï¼Œä½†ä¸å½±éŸ¿æ ¸å¿ƒåŠŸèƒ½"
          exit 0  # ä¸è®“å·¥ä½œæµç¨‹å¤±æ•—
        }
    
    - name: ğŸ” Verify results and generate summary
      run: |
        cd scripts
        echo "ğŸ” é©—è­‰åˆ†æçµæœä¸¦ç”Ÿæˆæ‘˜è¦..."
        python -c "
        import sys, json
        from datetime import datetime
        sys.path.append('.')
        
        try:
            from core.firebase_client import FirebaseClient
            
            client = FirebaseClient()
            
            # æª¢æŸ¥æœ€æ–°ç‹€æ…‹
            latest_status = client.get('latest_modular_status')
            
            summary = {
                'execution_time': datetime.now().isoformat(),
                'system_version': 'Simplified_v2.0_Stable',
                'firebase_connection': 'success',
                'analysis_results': None,
                'opportunities': 0,
                'system_health': 'unknown'
            }
            
            if latest_status:
                print('âœ… æ‰¾åˆ°æœ€æ–°åˆ†æç‹€æ…‹')
                summary['analysis_results'] = 'found'
                summary['last_update'] = latest_status.get('last_update', 'Unknown')
                summary['system_version_actual'] = latest_status.get('system_version', 'Unknown')
                
                summary_data = latest_status.get('summary', {})
                summary['opportunities'] = summary_data.get('total_opportunities', 0)
                summary['buy_signals'] = summary_data.get('buy_signals', 0)
                summary['sell_signals'] = summary_data.get('sell_signals', 0)
                summary['high_confidence'] = summary_data.get('high_confidence', 0)
                summary['system_health'] = latest_status.get('system_health', {}).get('status', 'unknown')
                
                print(f'   åˆ†ææ™‚é–“: {summary[\"last_update\"]}')
                print(f'   ç³»çµ±ç‰ˆæœ¬: {summary[\"system_version_actual\"]}')
                print(f'   æŠ•è³‡æ©Ÿæœƒ: {summary[\"opportunities\"]}')
                print(f'   è²·é€²ä¿¡è™Ÿ: {summary[\"buy_signals\"]}')
                print(f'   è³£å‡ºä¿¡è™Ÿ: {summary[\"sell_signals\"]}')
                print(f'   é«˜ä¿¡å¿ƒæ©Ÿæœƒ: {summary[\"high_confidence\"]}')
                print(f'   ç³»çµ±å¥åº·: {summary[\"system_health\"]}')
                
            else:
                print('âš ï¸ æœªæ‰¾åˆ°æœ€æ–°åˆ†æç‹€æ…‹')
                summary['analysis_results'] = 'not_found'
            
            # å°‡æ‘˜è¦ä¿å­˜ç‚ºGitHubç’°å¢ƒè®Šæ•¸
            with open('analysis_summary.json', 'w') as f:
                json.dump(summary, f, indent=2)
            
            print('ğŸ“Š åˆ†ææ‘˜è¦å·²ç”Ÿæˆ')
                
        except Exception as e:
            print(f'âŒ çµæœé©—è­‰å¤±æ•—: {e}')
            summary = {
                'execution_time': datetime.now().isoformat(),
                'firebase_connection': 'failed',
                'error': str(e)
            }
            
            with open('analysis_summary.json', 'w') as f:
                json.dump(summary, f, indent=2)
        "
    
    - name: ğŸ“Š Upload analysis summary
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: analysis-summary-${{ github.run_number }}
        path: scripts/analysis_summary.json
        retention-days: 30
    
    - name: ğŸ“ˆ Analysis execution summary
      if: always()
      run: |
        echo ""
        echo "ğŸ“Š ETFç­–ç•¥åˆ†æç³»çµ±åŸ·è¡Œæ‘˜è¦"
        echo "=============================================="
        echo "ğŸ“… åŸ·è¡Œæ—¥æœŸ: $(date '+%Y-%m-%d')"
        echo "â° åŸ·è¡Œæ™‚é–“: $(date '+%H:%M:%S UTC')"
        echo "ğŸ”§ ç³»çµ±ç‰ˆæœ¬: ç°¡åŒ–ç‰ˆ v2.0 (ç”Ÿç”¢ç’°å¢ƒ)"
        echo "ğŸ¯ åˆ†ææ¨¡å¼: ${{ github.event.inputs.analysis_mode || 'standard' }}"
        echo "ğŸ—ï¸ åŸ·è¡Œç’°å¢ƒ: Ubuntu Latest (GitHub Actions)"
        echo ""
        
        if [ -f "scripts/analysis_summary.json" ]; then
          echo "ğŸ“‹ åˆ†æçµæœæ‘˜è¦:"
          cat scripts/analysis_summary.json | python -m json.tool | grep -E '"(opportunities|buy_signals|sell_signals|system_health|firebase_connection)"'
        else
          echo "âš ï¸ åˆ†ææ‘˜è¦æ–‡ä»¶æœªæ‰¾åˆ°"
        fi
        
        echo ""
        echo "âœ… å®Œæˆçš„ä»»å‹™:"
        echo "   - ğŸ“¦ Pythonç’°å¢ƒè¨­ç½®å’Œä¾è³´å®‰è£"
        echo "   - ğŸ§ª é…ç½®ç³»çµ±é©—è­‰ï¼ˆé™¤æ¯æ—¥ç¨‹è¼‰å…¥ï¼‰"
        echo "   - ğŸŒ APIé€£æ¥æ¸¬è©¦ï¼ˆå¯é¸ï¼‰"
        if [[ "${{ github.event.inputs.analysis_mode }}" != "test_only" ]]; then
          echo "   - ğŸ”„ ETFæ•¸æ“šåˆ†æåŸ·è¡Œ"
        fi
        echo "   - ğŸ” çµæœé©—è­‰å’Œæ‘˜è¦ç”Ÿæˆ"
        echo "   - ğŸ’¾ Firebaseçµæœå„²å­˜"
        echo ""
        echo "ğŸ‰ ETFç­–ç•¥åˆ†æç³»çµ±åŸ·è¡Œå®Œæˆ!"
        echo "=============================================="
    
    - name: ğŸ’° Investment summary
      if: success()
      run: |
        echo ""
        echo "ğŸ’° æŠ•è³‡ç³»çµ±ç‹€æ…‹æ‘˜è¦:"
        echo "   - ğŸ¯ ç­–ç•¥ç‰ˆæœ¬: v2.0 ç°¡åŒ–ç©©å®šç‰ˆ"
        echo "   - ğŸ“Š é…ç½®ç³»çµ±: æ•´åˆåˆ†å±¤é…ç½®ï¼ˆéœæ…‹+å‹•æ…‹ï¼‰"
        echo "   - ğŸ“… é™¤æ¯ç®¡ç†: è‡ªå‹•åŒ–æ—¥ç¨‹è¿½è¹¤"
        echo "   - â˜ï¸ æ•¸æ“šå„²å­˜: Firebaseå³æ™‚è³‡æ–™åº«"
        echo "   - ğŸ”„ åŸ·è¡Œé »ç‡: é€±ä¸€åˆ°é€±äº”ï¼Œæ¯æ—¥å°ç£æ™‚é–“15:30"
        echo "   - ğŸ“ˆ æŠ•è³‡ç­–ç•¥: åŸºæ–¼é™¤æ¯é€±æœŸçš„7.08%å¹³å‡å ±é…¬ç­–ç•¥"
        echo ""
        echo "ğŸ“± ä½¿ç”¨Claude MCPæŸ¥è©¢æŠ•è³‡å»ºè­°:"
        echo "   - 'Claude, æŸ¥è©¢ç›®å‰çš„ETFæŠ•è³‡æ©Ÿæœƒ'"
        echo "   - 'Claude, 0056ç¾åœ¨é©åˆè²·é€²å—ï¼Ÿ'"
        echo "   - 'Claude, é¡¯ç¤ºé«˜ä¿¡å¿ƒåº¦çš„æŠ•è³‡æ©Ÿæœƒ'"
        echo ""
        echo "âš ï¸ æŠ•è³‡é¢¨éšªæé†’: æœ¬ç³»çµ±åƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡æœ‰é¢¨éšªè«‹è¬¹æ…æ±ºç­–"
    
    - name: ğŸš¨ Error notification
      if: failure()
      run: |
        echo "ğŸš¨ ETFåˆ†æç³»çµ±åŸ·è¡Œå¤±æ•—!"
        echo ""
        echo "å¯èƒ½çš„å•é¡Œ:"
        echo "1. Firebaseé€£æ¥å•é¡Œ - æª¢æŸ¥FIREBASE_URLè¨­ç½®"
        echo "2. è­‰äº¤æ‰€API SSLæ†‘è­‰å•é¡Œ - é€™æ˜¯å·²çŸ¥å•é¡Œ"
        echo "3. Pythonä¾è³´å•é¡Œ - æª¢æŸ¥requirements"
        echo "4. é…ç½®æ–‡ä»¶å•é¡Œ - æª¢æŸ¥configæ¨¡çµ„å®Œæ•´æ€§"
        echo ""
        echo "ç³»çµ±è¨­è¨ˆç‰¹è‰²:"
        echo "- å³ä½¿APIå¤±æ•—ï¼Œé…ç½®ç³»çµ±ä»å¯æ­£å¸¸é‹ä½œ"
        echo "- Firebaseä¸­çš„æ­·å²æ•¸æ“šå¯ç”¨æ–¼åˆ†æ"
        echo "- æ ¸å¿ƒæŠ•è³‡é‚è¼¯ä¸å—å¤–éƒ¨APIå½±éŸ¿"
        echo ""
        echo "å»ºè­°æª¢æŸ¥é …ç›®:"
        echo "- GitHub Secretsä¸­çš„FIREBASE_URLè¨­ç½®"
        echo "- æŸ¥çœ‹è©³ç´°çš„å·¥ä½œæµç¨‹æ—¥èªŒ"
        echo "- æª¢æŸ¥scripts/ç›®éŒ„ä¸‹çš„æ–‡ä»¶å®Œæ•´æ€§"