name: ETF Daily Analysis - Modular System

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ 15:30 åŸ·è¡Œ (UTC+8 = UTC 07:30)
    - cron: '30 7 * * 1-5'
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'åˆ†ææ¨¡å¼'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - quick  
        - dashboard_only

env:
  FIREBASE_URL: ${{ secrets.FIREBASE_URL }}

jobs:
  etf_analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy lxml beautifulsoup4
        
    - name: ğŸ§ª Quick module test
      run: |
        cd scripts
        python -c "
        import sys
        sys.path.append('.')
        
        print('ğŸ“¦ æ¸¬è©¦æ¨¡çµ„å°å…¥...')
        
        try:
            from config.etf_config import ETF_INFO, ETF_LIST
            print('âœ… é…ç½®æ¨¡çµ„å°å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ é…ç½®æ¨¡çµ„å¤±æ•—: {e}')
            
        try:
            from core.firebase_client import FirebaseClient
            print('âœ… Firebaseå®¢æˆ¶ç«¯å°å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ Firebaseå®¢æˆ¶ç«¯å¤±æ•—: {e}')
            
        try:
            from core.dividend_collector import DividendDateCollector
            print('âœ… é™¤æ¯æ”¶é›†å™¨å°å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ é™¤æ¯æ”¶é›†å™¨å¤±æ•—: {e}')
            
        print('ğŸ¯ æ¨¡çµ„æ¸¬è©¦å®Œæˆ')
        "
        
    - name: ğŸ¯ Run ETF Analysis
      if: github.event.inputs.analysis_mode != 'dashboard_only'
      timeout-minutes: 10
      run: |
        cd scripts
        echo "ğŸš€ é–‹å§‹åŸ·è¡ŒETFåˆ†æ..."
        echo "ğŸ“Š åˆ†ææ¨¡å¼: ${{ github.event.inputs.analysis_mode || 'full' }}"
        
        python main_analyzer.py
        
    - name: ğŸ¨ Generate Dashboard
      if: success()
      run: |
        cd scripts
        echo "ğŸ¨ ç”Ÿæˆå„€è¡¨æ¿..."
        python generate_dashboard.py
        
    - name: ğŸ“Š Verify Firebase Data
      if: success()
      run: |
        cd scripts
        python -c "
        import sys
        sys.path.append('.')
        from core.firebase_client import FirebaseClient
        
        try:
            client = FirebaseClient()
            
            # æª¢æŸ¥æœ€æ–°ç‹€æ…‹
            status = client.get_data('latest_modular_status')
            if status:
                print('âœ… Firebaseæœ€æ–°ç‹€æ…‹å·²æ›´æ–°')
                if 'opportunities' in status:
                    print(f'ğŸ“ˆ æŠ•è³‡æ©Ÿæœƒæ•¸é‡: {len(status[\"opportunities\"])}')
                if 'last_updated' in status:
                    print(f'ğŸ“… æœ€å¾Œæ›´æ–°: {status[\"last_updated\"]}')
            else:
                print('âš ï¸ Firebaseç‹€æ…‹æœªæ‰¾åˆ°')
                
            # æª¢æŸ¥å„€è¡¨æ¿
            dashboard = client.get_data('dashboard/latest')
            if dashboard:
                print('âœ… Firebaseå„€è¡¨æ¿å·²æ›´æ–°')
            else:
                print('âš ï¸ Firebaseå„€è¡¨æ¿æœªæ‰¾åˆ°')
                
        except Exception as e:
            print(f'âŒ Firebaseé©—è­‰å¤±æ•—: {e}')
        "
        
    - name: ğŸ“„ Deploy to GitHub Pages
      if: success()
      run: |
        echo "ğŸ“„ éƒ¨ç½²å„€è¡¨æ¿åˆ°GitHub Pages..."
        
        # æª¢æŸ¥æ˜¯å¦æœ‰index.htmlæ–‡ä»¶
        if [ -f "index.html" ]; then
          echo "âœ… ç™¼ç¾ index.html æ–‡ä»¶"
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $(wc -c < index.html) bytes"
          
          # è¨­å®šGité…ç½®
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æäº¤æ›´æ”¹
          git add index.html
          git commit -m "ğŸ¨ Update ETF dashboard - $(date '+%Y-%m-%d %H:%M:%S')" || echo "No dashboard changes"
          
          # æ¨é€æ›´æ”¹
          git push || echo "Push failed, but continuing..."
          
        else
          echo "âŒ æœªæ‰¾åˆ° index.html æ–‡ä»¶"
          ls -la | grep html || echo "ç›®éŒ„ä¸‹æ²’æœ‰htmlæ–‡ä»¶"
        fi
        
    - name: ğŸ“‹ Display Analysis Summary
      if: always()
      run: |
        cd scripts
        python -c "
        import sys
        sys.path.append('.')
        
        try:
            from core.firebase_client import FirebaseClient
            client = FirebaseClient()
            
            print('\\n' + '='*60)
            print('ğŸ¯ ETF åˆ†æç³»çµ±åŸ·è¡Œæ‘˜è¦')
            print('='*60)
            
            # ç²å–æœ€æ–°ç‹€æ…‹
            status = client.get_data('latest_modular_status')
            if status:
                print(f'ğŸ“… æœ€å¾Œæ›´æ–°: {status.get(\"last_updated\", \"æœªçŸ¥\")}')
                print(f'ğŸ¯ ç³»çµ±ç‰ˆæœ¬: {status.get(\"system_version\", \"æœªçŸ¥\")}')
                
                opportunities = status.get('opportunities', [])
                if opportunities:
                    print(f'\\nğŸ“ˆ æŠ•è³‡æ©Ÿæœƒ: {len(opportunities)} å€‹')
                    for opp in opportunities[:3]:  # é¡¯ç¤ºå‰3å€‹
                        print(f'  â€¢ {opp.get(\"etf_code\", \"æœªçŸ¥\")} - {opp.get(\"action\", \"æœªçŸ¥\")} - ä¿¡å¿ƒåº¦: {opp.get(\"confidence\", \"æœªçŸ¥\")}')
                else:
                    print('\\nğŸ“Š ç›®å‰ç„¡æŠ•è³‡æ©Ÿæœƒ')
                
                health = status.get('system_health', {})
                if health:
                    print(f'\\nğŸ¥ ç³»çµ±å¥åº·åº¦: {health.get(\"score\", \"æœªçŸ¥\")}%')
                    
            else:
                print('âš ï¸ ç„¡æ³•ç²å–åˆ†æç‹€æ…‹')
                
            print('\\n' + '='*60)
            print('âœ… åˆ†æå®Œæˆ')
            
        except Exception as e:
            print(f'âŒ æ‘˜è¦é¡¯ç¤ºå¤±æ•—: {e}')
        "
