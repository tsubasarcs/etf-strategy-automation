name: ETF Daily Analysis - Modular System

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ 15:30 åŸ·è¡Œ (UTC+8 = UTC 07:30)
    # æ”¶ç›¤å¾ŒåŸ·è¡Œï¼Œä½¿ç”¨å®Œæ•´ç•¶æ—¥æ•¸æ“šé€²è¡Œåˆ†æ
    - cron: '30 7 * * 1-5'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°æ•¸æ“š'
        required: false
        default: 'false'
        type: boolean
      analysis_mode:
        description: 'åˆ†ææ¨¡å¼'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - quick
        - dashboard_only

jobs:
  etf-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy lxml beautifulsoup4
    
    - name: ğŸ” Pre-flight check
      run: |
        echo "ğŸš€ ETFæ¨¡çµ„åŒ–åˆ†æç³»çµ±å•Ÿå‹•"
        echo "ğŸ“… åŸ·è¡Œæ™‚é–“: $(date)"
        echo "ğŸ”§ åˆ†ææ¨¡å¼: ${{ github.event.inputs.analysis_mode || 'full' }}"
        echo "âš¡ å¼·åˆ¶æ›´æ–°: ${{ github.event.inputs.force_update || 'false' }}"
        echo ""
        echo "ğŸ“ æª¢æŸ¥æ–‡ä»¶çµæ§‹:"
        find scripts -name "*.py" | head -10
    
    - name: ğŸ§ª Quick module test
      run: |
        cd scripts
        cat << 'EOF' > quick_test.py
        import sys
        sys.path.append('.')
        
        print("ğŸ§ª å¿«é€Ÿæ¨¡çµ„æ¸¬è©¦...")
        
        # æ¸¬è©¦é—œéµæ¨¡çµ„
        try:
            from config.etf_config import ETF_INFO, ETF_LIST
            print(f"âœ… é…ç½®æ¨¡çµ„: {len(ETF_INFO)} å€‹ETF")
        except Exception as e:
            print(f"âŒ é…ç½®æ¨¡çµ„å¤±æ•—: {e}")
            sys.exit(1)
        
        try:
            from core.firebase_client import FirebaseClient
            print("âœ… Firebaseå®¢æˆ¶ç«¯æ¨¡çµ„")
        except Exception as e:
            print(f"âŒ Firebaseå®¢æˆ¶ç«¯å¤±æ•—: {e}")
            sys.exit(1)
        
        try:
            import main_analyzer
            print("âœ… ä¸»åˆ†æå™¨æ¨¡çµ„")
        except Exception as e:
            print(f"âŒ ä¸»åˆ†æå™¨å¤±æ•—: {e}")
            sys.exit(1)
        
        print("ğŸ‰ æ‰€æœ‰é—œéµæ¨¡çµ„æ¸¬è©¦é€šé!")
        EOF
        python quick_test.py
    
    - name: ğŸ”„ Run main analysis
      if: ${{ github.event.inputs.analysis_mode != 'dashboard_only' }}
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        echo "ğŸ”„ é–‹å§‹åŸ·è¡Œä¸»åˆ†æç¨‹å¼..."
        timeout 600 python main_analyzer.py || {
          echo "âš ï¸ ä¸»åˆ†æå™¨åŸ·è¡Œè¶…æ™‚æˆ–é‡åˆ°å•é¡Œ"
          echo "é€™å¯èƒ½æ˜¯å› ç‚ºæ•¸æ“šæ”¶é›†éœ€è¦è¼ƒé•·æ™‚é–“"
          echo "æª¢æŸ¥Firebaseæ˜¯å¦æœ‰éƒ¨åˆ†æ•¸æ“šæ›´æ–°..."
        }
    
    - name: ğŸ¨ Generate dashboard
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        echo "ğŸ¨ ç”ŸæˆæŠ•è³‡ç­–ç•¥å„€è¡¨æ¿..."
        cat << 'EOF' > run_dashboard.py
        import sys
        sys.path.append('.')
        
        try:
            from generate_dashboard import ModularDashboard
            
            dashboard = ModularDashboard()
            success = dashboard.save_dashboard()
            
            if success:
                print("âœ… å„€è¡¨æ¿ç”Ÿæˆä¸¦ä¿å­˜æˆåŠŸ")
                dashboard.print_dashboard_url()
            else:
                print("âŒ å„€è¡¨æ¿ç”Ÿæˆå¤±æ•—")
                sys.exit(1)
                
        except Exception as e:
            print(f"âŒ å„€è¡¨æ¿ç”ŸæˆéŒ¯èª¤: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
        python run_dashboard.py
    
    - name: ğŸ” Verify results
      env:
        FIREBASE_URL: ${{ secrets.FIREBASE_URL }}
      run: |
        cd scripts
        echo "ğŸ” é©—è­‰åˆ†æçµæœ..."
        cat << 'EOF' > verify_results.py
        import sys
        sys.path.append('.')
        
        try:
            from core.firebase_client import FirebaseClient
            
            client = FirebaseClient()
            
            # æª¢æŸ¥æœ€æ–°ç‹€æ…‹
            latest_status = client.get('latest_modular_status')
            if latest_status:
                print("âœ… æ‰¾åˆ°æœ€æ–°åˆ†æç‹€æ…‹")
                print(f"   åˆ†ææ™‚é–“: {latest_status.get('last_update', 'Unknown')}")
                print(f"   ç³»çµ±ç‰ˆæœ¬: {latest_status.get('system_version', 'Unknown')}")
                
                summary = latest_status.get('summary', {})
                print(f"   æŠ•è³‡æ©Ÿæœƒ: {summary.get('total_opportunities', 0)}")
                print(f"   è²·é€²ä¿¡è™Ÿ: {summary.get('buy_signals', 0)}")
                print(f"   è³£å‡ºä¿¡è™Ÿ: {summary.get('sell_signals', 0)}")
                print(f"   é«˜ä¿¡å¿ƒæ©Ÿæœƒ: {summary.get('high_confidence', 0)}")
                
            else:
                print("âš ï¸ æœªæ‰¾åˆ°æœ€æ–°åˆ†æç‹€æ…‹")
            
            # æª¢æŸ¥å„€è¡¨æ¿
            dashboard_data = client.get('dashboard/latest')
            if dashboard_data:
                print("âœ… å„€è¡¨æ¿æ•¸æ“šå·²æ›´æ–°")
                print(f"   ç”Ÿæˆæ™‚é–“: {dashboard_data.get('generated_at', 'Unknown')}")
            else:
                print("âš ï¸ å„€è¡¨æ¿æ•¸æ“šæœªæ‰¾åˆ°")
                
        except Exception as e:
            print(f"âŒ çµæœé©—è­‰å¤±æ•—: {e}")
        EOF
        python verify_results.py
    
    - name: ğŸ“Š Analysis summary
      run: |
        echo ""
        echo "ğŸ“Š ETFæ¨¡çµ„åŒ–åˆ†æç³»çµ±åŸ·è¡Œæ‘˜è¦"
        echo "=============================================="
        echo "ğŸ“… åŸ·è¡Œæ—¥æœŸ: $(date '+%Y-%m-%d')"
        echo "â° åŸ·è¡Œæ™‚é–“: $(date '+%H:%M:%S')"
        echo "ğŸ”§ ç³»çµ±ç‰ˆæœ¬: æ¨¡çµ„åŒ– v1.0"
        echo "ğŸ¯ åˆ†ææ¨¡å¼: ${{ github.event.inputs.analysis_mode || 'full' }}"
        echo ""
        echo "âœ… å®Œæˆçš„ä»»å‹™:"
        echo "   - ğŸ“¦ æ¨¡çµ„å°å…¥æ¸¬è©¦"
        if [[ "${{ github.event.inputs.analysis_mode }}" != "dashboard_only" ]]; then
          echo "   - ğŸ”„ ä¸»åˆ†æç¨‹å¼åŸ·è¡Œ"
        fi
        echo "   - ğŸ¨ æŠ•è³‡å„€è¡¨æ¿ç”Ÿæˆ"
        echo "   - ğŸ” çµæœé©—è­‰"
        echo ""
        echo "ğŸ‰ ETFæ¨¡çµ„åŒ–åˆ†æç³»çµ±åŸ·è¡Œå®Œæˆ!"
        echo "=============================================="
    
    - name: ğŸš¨ Notify if critical issues
      if: failure()
      run: |
        echo "ğŸš¨ ETFåˆ†æç³»çµ±åŸ·è¡Œå¤±æ•—!"
        echo "è«‹æª¢æŸ¥ä»¥ä¸‹å¯èƒ½çš„å•é¡Œ:"
        echo "1. Firebaseé€£æ¥æ˜¯å¦æ­£å¸¸"
        echo "2. è­‰äº¤æ‰€APIæ˜¯å¦å¯ç”¨"
        echo "3. æ¨¡çµ„ä¾è³´æ˜¯å¦å®Œæ•´"
        echo "4. ç¶²è·¯é€£æ¥æ˜¯å¦ç©©å®š"
        echo ""
        echo "å»ºè­°æ‰‹å‹•åŸ·è¡Œæ¸¬è©¦å·¥ä½œæµç¨‹é€²è¡Œè©³ç´°è¨ºæ–·"
    
    - name: ğŸ“„ Deploy to GitHub Pages
      if: success()
      run: |
        echo "ğŸ“„ éƒ¨ç½²å„€è¡¨æ¿åˆ°GitHub Pages..."
        if [ -f "index.html" ]; then
          echo "âœ… ç™¼ç¾ index.html æ–‡ä»¶"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add index.html
          git commit -m "ğŸ¨ Update ETF dashboard - $(date '+%Y-%m-%d %H:%M:%S')" || echo "No dashboard changes"
          git push || echo "Push failed, but continuing..."
        else
          echo "âŒ æœªæ‰¾åˆ° index.html æ–‡ä»¶"
        fi
    
    - name: ğŸ“ˆ Investment opportunities alert
      if: success()
      run: |
        echo "ğŸ’° æŠ•è³‡æ©Ÿæœƒæé†’:"
        echo "   - ğŸŒ GitHub Pages: https://yourusername.github.io/yourrepo"
        echo "   - ğŸ“Š Firebase: æŸ¥çœ‹æ•¸æ“šåº«å„€è¡¨æ¿"
        echo "   - é—œæ³¨é«˜ä¿¡å¿ƒåº¦çš„æŠ•è³‡æ©Ÿæœƒ"
        echo "   - è«‹æ ¹æ“šé¢¨éšªæ‰¿å—èƒ½åŠ›èª¿æ•´æŠ•è³‡é‡‘é¡"
        echo ""
        echo "âš ï¸ é¢¨éšªæé†’: æŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è¬¹æ…æ±ºç­–"
